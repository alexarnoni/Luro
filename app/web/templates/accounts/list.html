{% extends "base.html" %}

{% block title %}{{ _('Contas/Cartões - Luro') }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _('Contas/Cartões') }}</h1>
    <button type="button" class="btn btn-primary" data-toggle-target="#account-form" data-toggle-focus="#name" aria-controls="account-form" aria-expanded="false">
    + {{ _('Adicionar conta/cartão') }}
    </button>
</div>

<section id="account-form" class="form-card" hidden aria-hidden="true">
    <h2>{{ _('Adicionar nova conta/cartão') }}</h2>
    <form method="post" action="/accounts">
        <div class="form-group">
            <label for="name">{{ _('Nome da conta') }}</label>
            <input type="text" id="name" name="name" required class="form-control" placeholder="{{ _('ex.: Conta corrente principal') }}" aria-describedby="name-help">
            <span class="form-hint" id="name-help">Use um nome fácil de identificar, como "Conta corrente".</span>
        </div>

        <div class="form-group">
            <label for="account_type">{{ _('Tipo de conta') }}</label>
            <select id="account_type" name="account_type" required class="form-control">
                <option value="checking">{{ _('Conta corrente') }}</option>
                <option value="savings">{{ _('Poupança') }}</option>
                <option value="credit">{{ _('Cartão de crédito') }}</option>
                <option value="investment">{{ _('Investimento') }}</option>
                <option value="other">{{ _('Outro') }}</option>
            </select>
        </div>
        
        <div class="form-group" data-non-credit>
            <label for="balance">{{ _('Saldo inicial') }}</label>
            <input type="number" id="balance" name="balance" step="0.01" value="0" class="form-control">
        </div>

        <div class="form-group grid-3" data-credit-only hidden>
            <div>
                <label for="credit_limit">{{ _('Limite (opcional)') }}</label>
                <input type="text" id="credit_limit" name="credit_limit" inputmode="decimal" class="form-control" aria-describedby="limit-help" placeholder="R$ 0,00">
            </div>
            <div>
                <label for="statement_day">{{ _('Dia de fechamento') }}</label>
                <input type="date" id="statement_day" name="statement_day" class="form-control" aria-describedby="close-help">
            </div>
            <div>
                <label for="due_day">{{ _('Dia de vencimento') }}</label>
                <input type="date" id="due_day" name="due_day" class="form-control" aria-describedby="close-help">
            </div>
        </div>
        <span class="form-hint" data-credit-only hidden id="limit-help">{{ _('Configure fechamento e vencimento para que as faturas funcionem corretamente. Limite é opcional, mas recomendável.') }}</span>
        <span class="form-hint" data-credit-only hidden id="close-help">{{ _('Use uma data para capturar o dia (apenas o dia será salvo).') }}</span>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ _('Criar conta/cartão') }}</button>
            <button type="button" class="btn btn-secondary" data-close-target="#account-form">{{ _('Cancelar') }}</button>
        </div>
    </form>
</section>

<div class="accounts-grid">
    {% if accounts %}
        {% for account in accounts %}
        <div class="account-card" data-account-row="{{ account.id }}">
            <h3 class="account-name">{{ account.name }}</h3>
            <p class="account-type">{{ {'checking': _('Conta corrente'), 'savings': _('Poupança'), 'credit': _('Cartão de crédito'), 'investment': _('Investimento'), 'other': _('Outro')}.get(account.account_type, account.account_type|title) }}</p>
            <p class="account-balance" data-account-id="{{ account.id }}">R$ {{ "%.2f"|format(account.balance) }}</p>
            {% if account.account_type == 'credit' %}
            <p class="account-meta">{{ _('Limite:') }} {{ account.credit_limit if account.credit_limit else _('Não informado') }} / {{ _('Fechamento:') }} {{ account.statement_day or '-' }} / {{ _('Vencimento:') }} {{ account.due_day or '-' }}</p>
            {% endif %}
            <div class="account-actions">
                <button type="button" class="btn btn-ghost" data-toggle-target="#account-edit-{{ account.id }}">{{ _('Editar') }}</button>
                <button type="button" class="btn btn-danger" data-delete-account="{{ account.id }}">{{ _('Excluir') }}</button>
            </div>

            <section id="account-edit-{{ account.id }}" class="form-card" hidden aria-hidden="true">
                <h4>{{ _('Editar conta') }}</h4>
                <form action="/accounts/{{ account.id }}/edit" method="post" class="account-edit-form-ajax" data-account-id="{{ account.id }}">
                    <div class="form-group">
                        <label for="account-name-{{ account.id }}">{{ _('Nome') }}</label>
                        <input id="account-name-{{ account.id }}" name="name" class="form-control" required value="{{ account.name }}">
                    </div>
                    <div class="form-group" data-non-credit>
                        <label for="account-balance-{{ account.id }}">{{ _('Saldo') }}</label>
                        <input id="account-balance-{{ account.id }}" name="balance" class="form-control" required value="{{ '%.2f'|format(account.balance) }}" data-non-credit>
                    </div>
                    {% if account.account_type == 'credit' %}
                    <div class="form-group grid-3">
                        <div>
                            <label for="credit-limit-{{ account.id }}">{{ _('Limite') }}</label>
                            <input id="credit-limit-{{ account.id }}" name="credit_limit" class="form-control" inputmode="decimal" value="{{ account.credit_limit if account.credit_limit is not none else '' }}" placeholder="R$ 0,00">
                        </div>
                        <div>
                            <label for="statement-day-{{ account.id }}">{{ _('Fechamento') }}</label>
                            <input id="statement-day-{{ account.id }}" name="statement_day" type="date" class="form-control" value="" data-day="{{ account.statement_day or '' }}">
                        </div>
                        <div>
                            <label for="due-day-{{ account.id }}">{{ _('Vencimento') }}</label>
                            <input id="due-day-{{ account.id }}" name="due_day" type="date" class="form-control" value="" data-day="{{ account.due_day or '' }}">
                        </div>
                    </div>
                    {% endif %}
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">{{ _('Salvar') }}</button>
                        <button type="button" class="btn btn-secondary" data-close-target="#account-edit-{{ account.id }}">{{ _('Cancelar') }}</button>
                    </div>
                </form>
            </section>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state" role="status" aria-live="polite">
            <span class="empty-state__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false" role="presentation"><path d="M20 7h-4.18C15.4 5.84 14.3 5 13 5h-2c-1.3 0-2.4.84-2.82 2H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Zm-8-1h2a1 1 0 0 1 .92.6L15.38 7H8.62l.46-1.4A1 1 0 0 1 12 6Zm8 11H4V9h16v8Zm-9-5h2v2h2v2h-2v2h-2v-2H9v-2h2v-2Z"/></svg>
            </span>
            <h2 class="empty-state__title">{{ _('Registre sua primeira conta') }}</h2>
            <p class="empty-state__description">{{ _('Organize seus saldos conectando contas bancárias ou carteiras que você acompanha manualmente.') }}</p>
            <div class="empty-state__actions">
                <button type="button" class="btn btn-primary" data-toggle-target="#account-form" data-toggle-focus="#name" aria-controls="account-form" aria-expanded="false">{{ _('Criar conta/cartão') }}</button>
                <a class="btn btn-ghost" href="/transactions" aria-label="{{ _('Ir para importar') }}">{{ _('Importar CSV/OFX') }}</a>
            </div>
        </div>
    {% endif %}
</div>
{% block extra_js %}
<script src="/static/js/ui.js?v={{ ASSETS_VERSION }}" defer></script>
<script src="/static/js/toast.js?v={{ ASSETS_VERSION }}" defer></script>
<script src="/static/js/accounts.js?v={{ ASSETS_VERSION }}" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const typeSelect = document.getElementById('account_type');
    const creditBlocks = document.querySelectorAll('[data-credit-only]');
    const nonCreditBlocks = document.querySelectorAll('[data-non-credit]');
    function sync() {
      const isCredit = typeSelect && typeSelect.value === 'credit';
      creditBlocks.forEach((el) => { el.hidden = !isCredit; });
      nonCreditBlocks.forEach((el) => { el.hidden = isCredit; });
    }
    if (typeSelect) {
      typeSelect.addEventListener('change', sync);
      sync();
    }
  });
</script>
{% endblock %}
{% endblock %}
