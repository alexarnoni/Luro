{% extends "base.html" %}

{% block title %}{{ _('Transações - Luro') }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _('Transações') }}</h1>
    <button type="button" class="btn btn-primary" data-toggle-target="#transaction-form" data-toggle-focus="#account_id" aria-controls="transaction-form" aria-expanded="false">
    + {{ _('Adicionar transação') }}
    </button>
</div>

<section id="transaction-form" class="form-card" hidden aria-hidden="true">
    <h2>{{ _('Adicionar nova transação') }}</h2>
    <form method="post" action="/transactions" id="transaction-create-form">
        <input type="hidden" name="account_id" id="account_id" value="">
        <div class="form-group">
            <label for="payment_method">{{ _('Forma de pagamento') }}</label>
            <select id="payment_method" name="payment_method" class="form-control" aria-describedby="payment-help">
                <option value="account">{{ _('Conta (débito)') }}</option>
                <option value="card">{{ _('Cartão de crédito') }}</option>
            </select>
            <span class="form-hint" id="payment-help">{{ _('Escolha se é lançamento direto em conta ou compra no cartão.') }}</span>
        </div>

        <div class="form-group" data-account-only>
            <label for="bank_account_id">{{ _('Conta') }}</label>
            <select id="bank_account_id" name="bank_account_id" class="form-control" aria-describedby="account-help">
                <option value="">{{ _('Selecione uma conta') }}</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.name }}</option>
                {% endfor %}
            </select>
            <span class="form-hint" id="account-help">{{ _('Escolha a conta onde o lançamento será registrado.') }}</span>
        </div>

        <div class="form-group" data-card-only hidden>
            <label for="card_account_id">{{ _('Cartão') }}</label>
            <select id="card_account_id" name="card_account_id" class="form-control" aria-describedby="card-help">
                <option value="">{{ _('Selecione um cartão') }}</option>
                {% for card in card_accounts %}
                <option value="{{ card.id }}">{{ card.name }}</option>
                {% endfor %}
            </select>
            <span class="form-hint" id="card-help">{{ _('Compras no cartão não alteram o saldo das contas. Configure fechamento e vencimento no cadastro do cartão.') }}</span>
        </div>

        <div class="form-group">
            <label for="transaction_type">{{ _('Tipo') }}</label>
            <select id="transaction_type" name="transaction_type" required class="form-control">
                <option value="income">{{ _('Receita') }}</option>
                <option value="expense">{{ _('Despesa') }}</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="amount">{{ _('Valor') }}</label>
            <input type="number" id="amount" name="amount" step="0.01" min="0" required class="form-control" placeholder="0.00" aria-describedby="amount-help">
            <span class="form-hint" id="amount-help">{{ _('Insira valores positivos; o tipo determina se é despesa ou receita.') }}</span>
        </div>

        <div class="form-group grid-2" data-card-only hidden>
            <div>
                <label for="installments_total">{{ _('Número de parcelas') }}</label>
                <input type="number" id="installments_total" name="installments_total" min="1" value="1" class="form-control">
            </div>
            <div>
                <label for="amount_per_installment">{{ _('Valor da parcela (opcional)') }}</label>
                <input type="number" id="amount_per_installment" step="0.01" min="0" class="form-control" aria-describedby="inst-help">
                <span class="form-hint" id="inst-help">{{ _('Preenche usar o valor total ÷ parcelas; edite se precisar arredondar.') }}</span>
            </div>
        </div>

        <div class="form-group">
            <label for="category_id">{{ _('Categoria') }}</label>
            <select id="category_id" name="category_id" class="form-control" aria-describedby="category-help">
                <option value="">{{ _('Selecione uma categoria') }}</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
                {% if text_categories %}
                <optgroup label="{{ _('Categorias recentes (texto livre)') }}">
                    {% for name in text_categories %}
                    <option value="__text__{{ name }}">{{ name }}</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
                <option value="__new__" {% if categories|length == 0 %}selected{% endif %}>{{ _('+ Criar nova categoria') }}</option>
            </select>
            <input type="text" id="new_category" name="new_category" class="form-control" placeholder="{{ _('Nome da nova categoria') }}" aria-describedby="category-help">
            <span class="form-hint" id="category-help">{{ _('Escolha uma categoria existente ou crie uma nova rapidamente.') }}</span>
        </div>
        
        <div class="form-group">
            <label for="description">{{ _('Descrição') }}</label>
            <input type="text" id="description" name="description" class="form-control" placeholder="{{ _('Descrição (opcional)') }}">
        </div>
        
        <div class="form-group">
            <label for="transaction_date">{{ _('Data') }}</label>
            <input type="datetime-local" id="transaction_date" name="transaction_date" class="form-control">
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ _('Adicionar transação') }}</button>
            <button type="button" class="btn btn-secondary" data-close-target="#transaction-form">{{ _('Cancelar') }}</button>
        </div>
    </form>
</section>

<div class="transactions-table">
    {% if transactions %}
    <table>
        <thead>
            <tr>
                <th>{{ _('Data') }}</th>
                <th>{{ _('Conta') }}</th>
                <th>{{ _('Tipo') }}</th>
                <th>{{ _('Categoria') }}</th>
                <th>{{ _('Descrição') }}</th>
                <th>{{ _('Valor') }}</th>
                <th>{{ _('Ações') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr data-txn-row="{{ transaction.id }}">
                <td>{{ transaction.transaction_date.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ transaction.account.name }}</td>
                                <td>
                                    <span class="badge badge-{{ transaction.transaction_type }}">
                                        {% if transaction.transaction_type == 'income' %}{{ _('Receita') }}{% else %}{{ _('Despesa') }}{% endif %}
                                    </span>
                                </td>
                <td>{{ transaction.category or '-' }}</td>
                <td class="txn-desc">{{ transaction.description or '-' }}</td>
                <td class="txn-amount {% if transaction.transaction_type == 'income' %}positive{% else %}negative{% endif %}">
                    {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}R$ {{ "%.2f"|format(transaction.amount) }}
                </td>
                <td>
                    <button type="button" class="btn btn-ghost" data-toggle-target="#txn-edit-{{ transaction.id }}">{{ _('Editar') }}</button>
                    <button type="button" class="btn btn-danger" data-delete-txn="{{ transaction.id }}">{{ _('Excluir') }}</button>
                </td>
            </tr>
            <tr id="txn-edit-{{ transaction.id }}" class="txn-edit-row" hidden>
                <td colspan="7">
                    <form action="/transactions/{{ transaction.id }}/edit" method="post" class="txn-edit-form-ajax" data-txn-id="{{ transaction.id }}">
                        <div class="txn-edit-inline">
                            <input name="description" class="form-control" value="{{ transaction.description or '' }}" placeholder="{{ _('Descrição') }}">
                            <input name="amount" class="form-control" value="{{ '%.2f'|format(transaction.amount) }}" placeholder="{{ _('Valor') }}">
                            <select name="transaction_type" class="form-control">
                                    <option value="income" {% if transaction.transaction_type=='income' %}selected{% endif %}>{{ _('Receita') }}</option>
                                    <option value="expense" {% if transaction.transaction_type=='expense' %}selected{% endif %}>{{ _('Despesa') }}</option>
                            </select>
                            <button type="submit" class="btn btn-primary">{{ _('Salvar') }}</button>
                            <button type="button" class="btn btn-secondary" data-close-target="#txn-edit-{{ transaction.id }}">{{ _('Cancelar') }}</button>
                        </div>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" role="status" aria-live="polite">
        <span class="empty-state__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false" role="presentation"><path d="M5 4a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H5Zm0 2h14a1 1 0 0 1 1 1v1H4V7a1 1 0 0 1 1-1Zm-1 4h16v7a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-7Zm5 2v2H6v-2h3Zm5 0v2h-3v-2h3Z"/></svg>
        </span>
    <h2 class="empty-state__title">{{ _('Ainda não há transações') }}</h2>
    <p class="empty-state__description">{{ _('Adicione lançamentos para registrar entradas e saídas ou importe um extrato existente.') }}</p>
        <div class="empty-state__actions">
            <button type="button" class="btn btn-primary" data-toggle-target="#transaction-form" data-toggle-focus="#account_id" aria-controls="transaction-form" aria-expanded="false">{{ _('Adicionar transação') }}</button>
            <a class="btn btn-ghost" href="/transactions" aria-label="{{ _('Importar transações') }}">{{ _('Importar CSV/OFX') }}</a>
        </div>
    </div>
    {% endif %}
</div>

<div class="transactions-table">
    <div class="page-header">
        <h2>{{ _('Compras em cartão') }}</h2>
    </div>
    {% if card_charges %}
    <table>
        <thead>
            <tr>
                <th>{{ _('Data') }}</th>
                <th>{{ _('Cartão') }}</th>
                <th>{{ _('Parcela') }}</th>
                <th>{{ _('Descrição') }}</th>
                <th>{{ _('Valor') }}</th>
                <th>{{ _('Fatura') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for charge in card_charges %}
            <tr>
                <td>{{ charge.purchase_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ charge.account.name }}</td>
                <td>{{ charge.installment_number }}/{{ charge.installment_total }}</td>
                <td>{{ charge.description or '-' }}</td>
                <td class="{% if charge.amount >=0 %}negative{% endif %}">R$ {{ '%.2f'|format(charge.amount) }}</td>
                <td>{% if charge.statement %}{{ '%02d/%04d'|format(charge.statement.month, charge.statement.year) }} ({{ charge.statement.status }}){% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" role="status" aria-live="polite">
        <p>{{ _('Sem compras em cartão ainda.') }}</p>
    </div>
    {% endif %}
</div>

<div class="transactions-table">
    <div class="page-header">
        <h2>{{ _('Faturas de cartão') }}</h2>
    </div>
    {% if card_statements %}
    <table>
        <thead>
            <tr>
                <th>{{ _('Referência') }}</th>
                <th>{{ _('Cartão') }}</th>
                <th>{{ _('Fechamento') }}</th>
                <th>{{ _('Vencimento') }}</th>
                <th>{{ _('Valor devido') }}</th>
                <th>{{ _('Pago') }}</th>
                <th>{{ _('Status') }}</th>
                <th>{{ _('Ações') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for stmt in card_statements %}
            <tr>
                <td>{{ '%02d/%04d'|format(stmt.month, stmt.year) }}</td>
                <td>{{ stmt.account.name }}</td>
                <td>{{ stmt.close_date }}</td>
                <td>{{ stmt.due_date }}</td>
                <td>R$ {{ '%.2f'|format(stmt.amount_due or 0) }}</td>
                <td>R$ {{ '%.2f'|format(stmt.amount_paid or 0) }}</td>
                <td>{{ stmt.status }}</td>
                <td>
                    <form action="/cards/{{ stmt.account_id }}/statements/{{ stmt.id }}/pay" method="post" class="inline-form">
                        <input type="number" step="0.01" name="amount" placeholder="{{ _('Valor pago') }}" class="form-control" required>
                        <button type="submit" class="btn btn-primary btn-small">{{ _('Registrar pagamento') }}</button>
                    </form>
                    <form action="/cards/{{ stmt.account_id }}/statements/{{ stmt.id }}/adjust" method="post" class="inline-form">
                        <input type="number" step="0.01" name="amount" placeholder="{{ _('Ajuste/Estorno') }}" class="form-control" required>
                        <input type="text" name="description" placeholder="{{ _('Descrição') }}" class="form-control">
                        <button type="submit" class="btn btn-secondary btn-small">{{ _('Ajustar') }}</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" role="status" aria-live="polite">
        <p>{{ _('Sem faturas abertas ou fechadas ainda.') }}</p>
    </div>
    {% endif %}
</div>
{% block extra_js %}
<script src="/static/js/ui.js?v={{ ASSETS_VERSION }}" defer></script>
<script src="/static/js/toast.js?v={{ ASSETS_VERSION }}" defer></script>
<script src="/static/js/transactions.js?v={{ ASSETS_VERSION }}" defer></script>
{% endblock %}
{% endblock %}
