{% extends "base.html" %}

{% block title %}{{ _('Transações - Luro') }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _('Transações') }}</h1>
    <button type="button" class="btn btn-primary" data-toggle-target="#transaction-form" data-toggle-focus="#account_id" aria-controls="transaction-form" aria-expanded="false">
    + {{ _('Adicionar transação') }}
    </button>
</div>

<section id="transaction-form" class="form-card" hidden aria-hidden="true">
    <h2>{{ _('Adicionar nova transação') }}</h2>
    <form method="post" action="/transactions">
        <div class="form-group">
            <label for="account_id">{{ _('Conta') }}</label>
            <select id="account_id" name="account_id" required class="form-control" aria-describedby="account-help">
                <option value="">{{ _('Selecione uma conta') }}</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.name }}</option>
                {% endfor %}
            </select>
            <span class="form-hint" id="account-help">{{ _('Escolha a conta onde o lançamento será registrado.') }}</span>
        </div>

        <div class="form-group">
            <label for="transaction_type">{{ _('Tipo') }}</label>
            <select id="transaction_type" name="transaction_type" required class="form-control">
                <option value="income">{{ _('Receita') }}</option>
                <option value="expense">{{ _('Despesa') }}</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="amount">{{ _('Valor') }}</label>
            <input type="number" id="amount" name="amount" step="0.01" min="0" required class="form-control" placeholder="0.00" aria-describedby="amount-help">
            <span class="form-hint" id="amount-help">{{ _('Insira valores positivos; o tipo determina se é despesa ou receita.') }}</span>
        </div>

        <div class="form-group">
            <label for="category">{{ _('Categoria') }}</label>
            <input type="text" id="category" name="category" class="form-control" placeholder="{{ _('ex.: Supermercado, Salário') }}" aria-describedby="category-help">
            <span class="form-hint" id="category-help">{{ _('Categorias ajudam a entender seus gastos. Você pode adicioná-las depois.') }}</span>
        </div>
        
        <div class="form-group">
            <label for="description">{{ _('Descrição') }}</label>
            <input type="text" id="description" name="description" class="form-control" placeholder="{{ _('Descrição (opcional)') }}">
        </div>
        
        <div class="form-group">
            <label for="transaction_date">{{ _('Data') }}</label>
            <input type="datetime-local" id="transaction_date" name="transaction_date" class="form-control">
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ _('Adicionar transação') }}</button>
            <button type="button" class="btn btn-secondary" data-close-target="#transaction-form">{{ _('Cancelar') }}</button>
        </div>
    </form>
</section>

<div class="transactions-table">
    {% if transactions %}
    <table>
        <thead>
            <tr>
                <th>{{ _('Data') }}</th>
                <th>{{ _('Conta') }}</th>
                <th>{{ _('Tipo') }}</th>
                <th>{{ _('Categoria') }}</th>
                <th>{{ _('Descrição') }}</th>
                <th>{{ _('Valor') }}</th>
                <th>{{ _('Ações') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr data-txn-row="{{ transaction.id }}">
                <td>{{ transaction.transaction_date.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ transaction.account.name }}</td>
                                <td>
                                    <span class="badge badge-{{ transaction.transaction_type }}">
                                        {% if transaction.transaction_type == 'income' %}{{ _('Receita') }}{% else %}{{ _('Despesa') }}{% endif %}
                                    </span>
                                </td>
                <td>{{ transaction.category or '-' }}</td>
                <td class="txn-desc">{{ transaction.description or '-' }}</td>
                <td class="txn-amount {% if transaction.transaction_type == 'income' %}positive{% else %}negative{% endif %}">
                    {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}R$ {{ "%.2f"|format(transaction.amount) }}
                </td>
                <td>
                    <button type="button" class="btn btn-ghost" data-toggle-target="#txn-edit-{{ transaction.id }}">{{ _('Editar') }}</button>
                    <button type="button" class="btn btn-danger" data-delete-txn="{{ transaction.id }}">{{ _('Excluir') }}</button>
                </td>
            </tr>
            <tr id="txn-edit-{{ transaction.id }}" class="txn-edit-row" hidden>
                <td colspan="7">
                    <form action="/transactions/{{ transaction.id }}/edit" method="post" class="txn-edit-form-ajax" data-txn-id="{{ transaction.id }}">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input name="description" class="form-control" value="{{ transaction.description or '' }}" placeholder="{{ _('Descrição') }}">
                            <input name="amount" class="form-control" value="{{ '%.2f'|format(transaction.amount) }}" placeholder="{{ _('Valor') }}">
                            <select name="transaction_type" class="form-control">
                                    <option value="income" {% if transaction.transaction_type=='income' %}selected{% endif %}>{{ _('Receita') }}</option>
                                    <option value="expense" {% if transaction.transaction_type=='expense' %}selected{% endif %}>{{ _('Despesa') }}</option>
                            </select>
                            <button type="submit" class="btn btn-primary">{{ _('Salvar') }}</button>
                            <button type="button" class="btn btn-secondary" data-close-target="#txn-edit-{{ transaction.id }}">{{ _('Cancelar') }}</button>
                        </div>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" role="status" aria-live="polite">
        <span class="empty-state__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false" role="presentation"><path d="M5 4a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H5Zm0 2h14a1 1 0 0 1 1 1v1H4V7a1 1 0 0 1 1-1Zm-1 4h16v7a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-7Zm5 2v2H6v-2h3Zm5 0v2h-3v-2h3Z"/></svg>
        </span>
    <h2 class="empty-state__title">{{ _('Ainda não há transações') }}</h2>
    <p class="empty-state__description">{{ _('Adicione lançamentos para registrar entradas e saídas ou importe um extrato existente.') }}</p>
        <div class="empty-state__actions">
            <button type="button" class="btn btn-primary" data-toggle-target="#transaction-form" data-toggle-focus="#account_id" aria-controls="transaction-form" aria-expanded="false">{{ _('Adicionar transação') }}</button>
            <a class="btn btn-ghost" href="/transactions" aria-label="{{ _('Importar transações') }}">{{ _('Importar CSV/OFX') }}</a>
        </div>
    </div>
    {% endif %}
</div>
{% block extra_js %}
<script src="/static/js/ui.js" defer></script>
<script src="/static/js/toast.js" defer></script>
<script src="/static/js/transactions.js" defer></script>
{% endblock %}
{% endblock %}
